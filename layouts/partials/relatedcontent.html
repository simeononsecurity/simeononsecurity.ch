{{ if or (strings.Contains $.Page.RelPermalink "/articles/") (strings.Contains $.Page.RelPermalink "/github/") (strings.Contains $.Page.RelPermalink "/recommendations/") (strings.Contains $.Page.RelPermalink "/writeups/") (strings.Contains $.Page.RelPermalink "/other/") (strings.Contains $.Page.RelPermalink "/blog/") }}
  {{- range first 1 (where (where .Site.Pages ".Params.tags" "intersect" .Params.tags) "Permalink" "!=" .Permalink) -}}
    {{- $.Scratch.Set "has_related" true -}}
  {{- end -}}

  {{ if $.Scratch.Get "has_related" }}
    <div id="related-section">
      <div class="related-content">
        <h3>Related Posts</h3>
        <div class="related-posts-list">
          {{- $num_to_show := .Site.Params.related_content_limit | default 2 -}}
          {{ range first $num_to_show (where (where .Site.Pages ".Params.tags" "intersect" .Params.tags) "Permalink" "!=" .Permalink) }}
          <div class="related">
              {{ if .Params.Cover }}
                {{ $cover := ""}}
                {{ if .Params.UseRelativeCover }}{{ $cover = resources.GetRemote (printf "%s%s" .Permalink .Params.Cover) }}{{ else }}{{ $cover = resources.Get (.Params.Cover) }}{{ end }}
                {{ $micro := ($cover.Resize "20x webp q20") }}
                {{ $tiny := ($cover.Resize "240x webp q50") }}
                {{ $small := ($cover.Resize "480x webp q50") }}
            <div class="related-image">
              <a href="{{ .RelPermalink }}">
                <picture>
                  <source 
                    srcset="{{ $small.RelPermalink }} 480w, {{ $tiny.RelPermalink }} 240w" 
                    sizes="(min-width: 780px) 480px, (min-width: 384px) 240px, 20px, calc(80.53vw - 21px)"
                    media="(min-width: 200px)">
                  <img src="{{ $micro.RelPermalink }}"
                    alt="{{ .Params.CoverAlt | plainify | default .Title }}"
                    height="731"
                    width="480"
                    loading="lazy"
                  />
                </picture>  
              </a>
              {{ end }}
            </div>
            <div class="related-info">
              <div class="related-date">
                <time datetime="{{ .Date.UTC.Format "2006-01-02T15:04:05-0700" }}">
                  {{ .Date.Format "Jan 2, 2006" }}
                </time>
              </div>
              <div class="related-title">
                <a href="{{ .RelPermalink }}">{{ .Title }}</a>
              </div>
            </div>
          </div>
          {{ end }}
        </div>
      </div>
    </div>
  {{ end }}
{{ end }}
