<script
  async
  data-ad-client="ca-pub-4092442123207538"
  src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4092442123207538"
  crossorigin="anonymous"
></script>
<script defer>
  window.addEventListener("load", function() {
    var adPlaceholders = document.querySelectorAll(".ad-placeholder");
    var totalAds = adPlaceholders.length;
    var adsLoaded = 0;
    var observer;

    function handleContentLoaded() {
      try {
        (adsbygoogle = window.adsbygoogle || []).push({
          done_loading: function() {
            adsLoaded++;
            console.log("Ad loaded:", adsLoaded, "/", totalAds);
            if (adsLoaded === totalAds) {
              // All ads have been loaded, disconnect the observer
              console.log("All ads have been loaded. Disconnecting the observer.");
              observer.disconnect();
            }
          },
        });
      } catch (error) {
        // Handle the error gracefully
        console.error("An error occurred while handling content load:", error);
      }
    }

    function fixGoogleIframes() {
      try {
        var iframes = document.querySelectorAll(
          'iframe[src*="https://googleads.g.doubleclick.net"], iframe[data-google-container-id]'
        );

        function setAttributes(iframe) {
          var containerId = iframe.getAttribute("data-google-container-id");
          console.log("Setting attributes for iframe:", iframe);
          iframe.setAttribute("title", "google ads");
          iframe.setAttribute("role", "banner");
        }

        iframes.forEach(function(iframe) {
          iframe.setAttribute("title", "google ads");
          iframe.setAttribute("role", "banner");

          if (
            iframe.hasAttribute("data-google-container-id") &&
            iframe.complete
          ) {
            setAttributes(iframe);
          } else {
            iframe.addEventListener("load", function() {
              setAttributes(iframe);
            });
          }
        });
      } catch (error) {
        // Handle any errors that occur during the execution of the code
        console.error("An error occurred:", error);
      }
    }

    // Create a new Intersection Observer
    observer = new IntersectionObserver(
      function(entries) {
        entries.forEach(function(entry) {
          if (entry.isIntersecting) {
            // Call the function to handle content loaded only if it hasn't been executed before
            var adPlaceholder = entry.target;
            console.log("Ad placeholder is in view:", adPlaceholder);
            if (!adPlaceholder.dataset.loaded) {
              console.log("Loading ad for placeholder:", adPlaceholder);
              handleContentLoaded();
              // Mark the ad as "loaded" to prevent multiple executions
              adPlaceholder.dataset.loaded = true;
              fixGoogleIframes();
            }
          }
        });
      },
      {
        root: null, // Use the viewport as the root
        rootMargin: "100px", // Set the margin to 100px around the viewport
        threshold: 0.5, // Trigger when the target enters the root
      }
    );

    // Start observing each ad placeholder element
    for (var i = 0; i < totalAds; i++) {
      observer.observe(adPlaceholders[i]);
      console.log("Observer started observing ad placeholder:", adPlaceholders[i]);
    }
  });
</script>

